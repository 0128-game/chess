<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学習するAIチェス (修正版)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <style>
        /* CSSは前回と同じです */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #2c2f33;
            color: #ffffff;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #36393f;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 100%;
        }
        h1 {
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            margin-top: 0;
            margin-bottom: 20px;
        }
        .board {
            width: 90vw;
            max-width: 450px;
        }
        .info {
            margin-top: 20px;
            font-size: clamp(1rem, 4vw, 1.1rem);
            text-align: center;
        }
        #status, #ai-thinking {
            font-weight: bold;
            display: block;
            min-height: 1.2em;
            margin-top: 5px;
        }
        #status { color: #f9a825; }
        #ai-thinking { color: #4fc3f7; }
        .buttons {
            margin-top: 15px;
        }
        button {
            background-color: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        button:hover { background-color: #4752c4; }
        #clear-memory-button { background-color: #ed4245; }
        #clear-memory-button:hover { background-color: #c83739; }
    </style>
</head>
<body>
    <div class="container">
        <h1>学習するAIチェス</h1>
        <div id="board" class="board"></div>
        <div class="info">
            <span id="status"></span>
            <span id="ai-thinking"></span>
        </div>
        <div class="buttons">
            <button id="reset-button">リセット</button>
            <button id="clear-memory-button">AIの記憶を消去</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0-beta.6/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
    // グローバルスコープの汚染を防ぐために即時関数で囲む
    (function() {
        // DOMが読み込まれたら実行
        $(document).ready(function() {
            let board = null;
            // chess.js v1.x では `new Chess()` ではなく `new chess.Chess()` を使います
            const game = new chess.Chess();
            const $status = $('#status');
            const $aiThinking = $('#ai-thinking');

            const AI_SEARCH_DEPTH = 3;
            let learningData = JSON.parse(localStorage.getItem('chessAIData')) || {};

            function updateStatus() {
                let statusText = '';
                const moveColor = game.turn() === 'b' ? '黒' : '白';

                if (game.isCheckmate()) {
                    statusText = `チェックメイト！ ${moveColor === '白' ? '黒' : '白'}の勝ちです。`;
                } else if (game.isDraw()) {
                    statusText = '引き分けです。';
                } else {
                    statusText = `${moveColor}の手番です。`;
                    if (game.isCheck()) {
                        statusText += ' (チェックされています)';
                    }
                }
                $status.text(statusText);
            }
            
            // --- AIの学習結果を保存する関数 ---
            function recordGameResult() {
                const pgn = game.pgn({ max_width: 5 }); // 序盤数手の棋譜をキーにする
                const key = pgn.split('\n')[3] || pgn; // 3手目までの棋譜を取得
                
                if (!learningData[key]) {
                    learningData[key] = { ai_win: 0, ai_loss: 0, draw: 0 };
                }

                if (game.isCheckmate()) {
                    // game.turn() はチェックメイトされた側の色を返す
                    if (game.turn() === 'w') { // 白(プレイヤー)が負け
                        learningData[key].ai_win++;
                    } else { // 黒(AI)が負け
                        learningData[key].ai_loss++;
                    }
                } else if (game.isDraw()) {
                    learningData[key].draw++;
                }

                localStorage.setItem('chessAIData', JSON.stringify(learningData));
                console.log("AI: この対局の結果を記憶しました。", learningData);
            }

            // --- AIの思考ロジック (変更なし) ---
            const pieceValue = { p: 1, n: 3, b: 3, r: 5, q: 9, k: 900 };
            function evaluateBoard(board) {
                let totalEvaluation = 0;
                board.forEach(row => {
                    row.forEach(piece => {
                        if (piece) {
                            totalEvaluation += (piece.color === 'w' ? pieceValue[piece.type] : -pieceValue[piece.type]);
                        }
                    });
                });
                return totalEvaluation;
            }

            function minimax(game, depth, alpha, beta, isMaximizingPlayer) {
                if (depth === 0) return -evaluateBoard(game.board());
                const moves = game.moves();
                if (isMaximizingPlayer) {
                    let bestVal = -Infinity;
                    for (const move of moves) {
                        game.move(move);
                        bestVal = Math.max(bestVal, minimax(game, depth - 1, alpha, beta, false));
                        game.undo();
                        alpha = Math.max(alpha, bestVal);
                        if (beta <= alpha) break;
                    }
                    return bestVal;
                } else {
                    let bestVal = Infinity;
                    for (const move of moves) {
                        game.move(move);
                        bestVal = Math.min(bestVal, minimax(game, depth - 1, alpha, beta, true));
                        game.undo();
                        beta = Math.min(beta, bestVal);
                        if (beta <= alpha) break;
                    }
                    return bestVal;
                }
            }

            function getAIBestMove() {
                let bestMove = null;
                let bestValue = -Infinity;
                const moves = game.moves();
                
                // 学習データに基づいて序盤の手を並び替える
                const pgn = game.pgn({ max_width: 5 });
                const key = pgn.split('\n')[3] || pgn;
                if (learningData[key] && learningData[key].ai_loss > learningData[key].ai_win) {
                    console.log("AI: この展開は分が悪い... 少し違う手を試そう。");
                    moves.sort(() => Math.random() - 0.5); // ランダムに並び替え
                }

                for (const move of moves) {
                    game.move(move);
                    const boardValue = minimax(game, AI_SEARCH_DEPTH, -Infinity, Infinity, false);
                    game.undo();
                    if (boardValue > bestValue) {
                        bestValue = boardValue;
                        bestMove = move;
                    }
                }
                return bestMove;
            }

            function makeAIMove() {
                if (game.isGameOver()) return;
                $aiThinking.text('考え中...');
                setTimeout(() => {
                    const move = getAIBestMove();
                    game.move(move);
                    board.position(game.fen());
                    updateStatus();
                    $aiThinking.text('');
                    if (game.isGameOver()) {
                        recordGameResult();
                    }
                }, 250);
            }
            
            // --- チェス盤のイベントハンドラ ---
            function onDragStart(source, piece) {
                return !game.isGameOver() && game.turn() === 'w' && piece.startsWith('w');
            }

            function onDrop(source, target) {
                try {
                    const move = game.move({ from: source, to: target, promotion: 'q' });
                    if (move === null) return 'snapback';
                } catch (e) {
                    return 'snapback';
                }
                updateStatus();
                if (game.isGameOver()) {
                    recordGameResult();
                } else {
                    window.setTimeout(makeAIMove, 250);
                }
            }

            function onSnapEnd() {
                board.position(game.fen());
            }

            // --- 初期化 ---
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('board', config); // IDを 'board' に修正
            updateStatus();

            $('#reset-button').on('click', () => {
                game.reset();
                board.start();
                updateStatus();
            });

            $('#clear-memory-button').on('click', () => {
                if (confirm("本当にAIの記憶（学習データ）をすべて消去しますか？")) {
                    localStorage.removeItem('chessAIData');
                    learningData = {};
                    alert("AIの記憶を消去しました。");
                }
            });
        });
    })();
    </script>
</body>
</html>
